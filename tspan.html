<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric.js Canvas Example</title>
    <script src="./fabric.min.js"></script>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" width="1800" height="1000"></canvas>
    <script>
        // Initialize Fabric.js canvas
        var canvas = new fabric.Canvas('myCanvas');
        const svgPath = './svg.svg';
        const importSvgCode = (ss, canvas) => {
            if (ss) {
                fabric.loadSVGFromString(ss).then(output => {
                    parseSvg(output, canvas);
                });
                canvas.requestRenderAll();
            }
        };

        const parseSvg = (output, canvas) => {
            console.log(output);
            // eslint-disable-next-line
            const { objects, elements, options, allElements } = output;
            const extrapropertyTags = allElements.filter((svgTag) => svgTag.tagName === 'extraproperty');
            var textNumber = 0;
            objects.forEach((obj, index) => {
                if (obj.type === 'text') {

                    // Extract the extraproperty tag if needed
                    const width = extrapropertyTags[textNumber].getAttribute('width');
                    const textAlign = extrapropertyTags[textNumber].getAttribute('textAlign');
                    const lines = extrapropertyTags[textNumber].getAttribute('lines');
                    console.log(width, textAlign, lines);
                    textNumber++;
                    
                    const currentElement = elements[index];

                    // Concatenate all the tspans into one text with newline characters
                    let combinedText = '';
                    Array.from(currentElement.children).forEach((tspan) => {
                        combinedText += tspan.innerHTML + '\n'; // Adds each tspan's text and a newline
                    });

                    // Remove the last newline if unnecessary
                    combinedText = combinedText.trimEnd();

                    const tspan = currentElement.children[0];
                    const { x, y } = tspan.attributes;

                    let leftPosition = obj.left;

                    // Adjust the x position based on alignment
                    if (textAlign === 'center') {
                        leftPosition = obj.left - parseInt(width) / 2; 
                    } else if (textAlign === 'right') {
                        leftPosition = obj.left - parseInt(width) / 2;
                    } else {
                        leftPosition = obj.left + Number(x.value); 
                    }

                    // Create a new Textbox with combined tspan text
                    const text = new fabric.Textbox(combinedText, {
                        ...obj,
                        left: leftPosition,
                        top: obj.top + Number(y.value),
                        textAlign: textAlign, // Set text alignment from extraproperty
                        width: parseInt(width), // Set width from extraproperty
                    });

                    // Add the text to the canvas
                    return canvas.add(text);
                } else {
                    // Add non-text objects directly to the canvas
                    canvas.add(obj);
                }
            });
        };

        const generateUniqueId = (object) => {
            return object.type + "_" + Number(Math.floor(Math.random() * 900) + 100); // Generates a number between 100 and 999
        };
        const shadowOptions = {
            color: "#000000",
            blur: 30,
            offsetX: 0,
            offsetY: 0,
            affectStroke: false,
        };

        const importSVG = (file) => {
            if (file) {
                var site_url = file;
                fabric.loadSVGFromURL(site_url).then(output => {
                    parseSvg(output, canvas);
                });
                canvas.renderAll();
            }
        };

        importSVG(svgPath)

    </script>
</body>

</html>